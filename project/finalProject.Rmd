---
title: "Math 225 Final Project: Airbnb"
author: "Brendan Doyle, Roger Wang, Sabrina Ma"
date: "May 11, 2017"
output: html_document
---
## Team Members

Brendan Doyle, bjd54

Roger Wang, rw794

Sabrina Ma, slm243

##Abstract 

Airbnb is an online platform that enables people to lease or rent short-term properties. This project seeks to use data visualization to analyze Airbnb and its effect on large metropolitan cities. Our three research focuses include characteristics of listings and hosts, listing prices by region, and user reviews over time. To explore the first research topic, we created pie and stacked bar charts that display listing by room type, density plots and stacked bar charts that display the distribution of listings per host, and a scatterplot that displays listing availability vs. minimum nights allowed. To explore our second question, we created a Shiny application that maps the price and location of listings in DC, New York, San Francisco, Amsterdam, and London. We mapped size of points to price and color to neighborhood for greater aesthetic detail and made features like region selection and zoom for greater user interaction.  Using the `ggmaps` package, we also implemented a feature that plots the points on a Google Maps plot. Finally, we investigated our third research topic by creating a time series plot that displays the number of user reviews over time grouped by neighborhood. We also embed this in our Shiny app, which provides an animation feature so users can see dynamically observe change over time. From our visualizations, we discovered that there are in fact indicators of a housing crisis, but Airbnb's impact is probably not as dire as the media portrays it to be. Our map graphs show that listing prices have not drastically increased over time, but there are often some relatively more expensive listings in popular neighborhoods. Finally, our time series graphs show that the frequency of user reviews does vary by neighborhood, which is aligned with our hypothesis that some neighborhoods are "up-and-coming," which may be a signifier of gentrificiation. 

##Introduction

Valued at over $30 billion dollars, Airbnb is truly disrupting the hospitality industry. This has led to a contentious debate over Airbnb's role in and affect on housing markets in large metropolitan cities. Proponents of Airbnb say that if Airbnbs were not rented out, they would be vacant. According to [LA Times ](http://www.latimes.com/opinion/op-ed/la-oe-0513-yaffe-airbnb-ordinance-la-20160513-story.html), hosts are "renters who manage to pay their inflated rents on time thanks to income generated by subletting part of their space through Airbnb." On the other hand, opponents say that Airbnb is driving rental prices up and changing the demographic characteristics of neighborhoods that are linked to gentrification. According to [BJH Advisors](https://skift.com/2016/06/28/measuring-the-impact-of-airbnb-rentals-on-new-york-citys-housing-crisis/), a real estate development and advisory firm, Airbnb units that are most likely to contribute to a city's housing crisis include entire apartments/homes rented by commercial hosts who either rented out multiple units for at least three months per year, or had a single listing rented for at least six months per year.

The goal of our final report is to analyze and visualize Airbnb, geographic, and housing data to gain further insight into the different facets of this debate. In particular, our three research areas are listing/host characteristics, rent prices, and frequency of user reviews.

1) What types of places are being rented? How many listings do hosts generally have? Is there a relationship between listing type, count of listings per host, and other variables such as minimum stay and availability?

2) How does median listing price and profitability vary by neighborhood?  

3) How has the number of reviews for listing in up-and-coming neighborhoods changed over time? 

##Data

###Data Description

The data we are using is from insideairbnb.com. The data was collected from public data on the AirBnB site through their API. The data sets hold extensive info about AirBnB listings in the DC area. The data contains info about the person who made the listing, the host id, the name of the listing, the neighborhood the listing is in, the latitude and longitude, the type of room, the price, the minimum number of nights you can rent the listing, the number of reviews the listing has, the last time the listing was reviewed, the number of reviews, the number of days out of the year the listing is available, and detailed reviews and listing info. We also will need to use a dataset that maps the neighborhood info to an actual DC map by neighborhood as well as mean rent prices by neighborhood. The data has already been extensively processed by the creators of the insideairbnb website. With that said, that means we have to trust that the creators of the website performed good cleansing of the data and did not make invalid assumptions while doing their processing.

###Data Manipulation

####Load Data

First, we loaded the listing, neighborhood, and review data for our five regions of interest. 

```{r}
library(lubridate)
library(zoo)
library(rgdal)
library(rgeos)
library(tidyverse)
library(ggmap)
library(plotly)

DC_li<-read.csv("DC_listings.csv")
DC_nei<-read.csv("DC_neighbourhoods.csv")
DC_rev<-read.csv("DC_reviews.csv")

SF_li<-read.csv("SF_listings.csv")
SF_nei<-read.csv("SF_neighbourhoods.csv")
SF_rev<-read.csv("SF_reviews.csv")

NY_li<-read.csv("NY_listings.csv")
NY_nei<-read.csv("NY_neighbourhoods.csv")
NY_rev<-read.csv("NY_reviews.csv")

LON_li<-read.csv("LON_listings.csv")
LON_nei<-read.csv("LON_neighbourhoods.csv")
LON_rev<-read.csv("LON_reviews.csv")

AMS_li<-read.csv("AMS_listings.csv")
AMS_nei<-read.csv("AMS_neighbourhoods.csv")
AMS_rev<-read.csv("AMS_reviews.csv")
```


####Question One Graphs

Photo one's upper left corner graph uses DC_li$room_type

```
#q1g1_1

#levels(DC_li$room_type)
```

First photo's upper right corner graph needs to summarize the data by neighbourhood and room_type to calculate the percentage.

```
#q1g1_2

#levels(DC_li$neighbourhood)
DC_room_pct <- summarize(group_by(DC_li,neighbourhood,room_type),pct=n()/nrow(DC_li))
```

First photo's bottom graph uses each country's room_type.

```
#q1g1_3

DC_li$room_type
AMS_li$room_type
LON_li$room_type
NY_li$room_type
SF_li$room_type
```

Second photo's graph uses each country's calculated_host_listings_count.

```
#q1g2

DC_li$calculated_host_listings_count
AMS_li$calculated_host_listings_count
LON_li$calculated_host_listings_count
NY_li$calculated_host_listings_count
SF_li$calculated_host_listings_count
```

Third photo's graph separates the number of listings into three groups 1-5, 6-10, 10+. Then do a summary for each group by the room_type. At last, join these summaries together by room_type.

```
#q1g3

DC_li$calculated_host_listings_count
li_1_5 <- filter(DC_li,calculated_host_listings_count>=1&calculated_host_listings_count<=5)
li_6_10 <- filter(DC_li,calculated_host_listings_count>=6&calculated_host_listings_count<=10)
li_10up <- filter(DC_li,calculated_host_listings_count>=11)
li_1_5_sum <- summarise(group_by(li_1_5,room_type),count=n())
li_6_10_sum <- summarise(group_by(li_6_10,room_type),count=n())
li_10up_sum <- summarise(group_by(li_10up,room_type),count=n())
DC_room_li <- inner_join(li_1_5_sum,li_6_10_sum,by="room_type")
DC_room_li <- inner_join(DC_room_li,li_10up_sum,by="room_type")
```
Fourth graph uses minimum_nights, availability_365, and calculated_host_listings_count.

```
#q1g4

DC_li$minimum_nights
DC_li$availability_365
DC_li$calculated_host_listings_count

```

####Question Two's Graph

This graph requires data about listing location and prices grouped by neighborhood. For use in our map graphs, we loaded GeoJSON data for each region. GeoJSON is a format for encoding a variety of geographic data structures. We will merged these datasets with the review dataset to aggregate our data source. To find median listing price by neighorhood, we used `summarise` and `group by` methods.`gCentroid` calculates the center of each neighborhood so we can accurately map them to neighborhood labels.


```{r}

#DC
#Change listing_id attribute to id so inner join can be made 
names(DC_rev)[names(DC_rev)=="listing_id"] <- "id"
DC_rev_and_list <- inner_join(DC_li,DC_rev,by="id")
remove(DC_li)
remove(DC_rev)

#Join listing and review tables on listing id
DC_rev_and_list$date <- as.Date(DC_rev_and_list$date)
DC_rev_and_list$month <- month(DC_rev_and_list$date,label=T,abbr=T)
DC_rev_and_list$year <- year(DC_rev_and_list$date)

#Convert date to YYY-MM-DD to YYY-Month format
DC_map <- readOGR("maps/DC_neighbourhoods.geojson", "OGRGeoJSON")
DC_price <- summarise(group_by(DC_rev_and_list,neighbourhood,year),price=median(price))
DC_rev_year_sum <- summarize(group_by(DC_rev_and_list, neighbourhood, year, month), number_of_reviews=n())
DC_map_centers <- gCentroid(DC_map,byid=T)
DC_map_label <- cbind(as.data.frame(DC_map_centers),DC_map@data$neighbourhood)
remove(DC_map_centers)
names(DC_map_label)[3]<-"name"
DC_map_cart <- fortify(DC_map)

#AMS
names(AMS_rev)[names(AMS_rev)=="listing_id"] <- "id"
AMS_rev_and_list <- inner_join(AMS_li,AMS_rev,by="id")
remove(AMS_li)
remove(AMS_rev)

AMS_rev_and_list$date <- as.Date(AMS_rev_and_list$date)
AMS_rev_and_list$month <- month(AMS_rev_and_list$date,label=T,abbr=T)
AMS_rev_and_list$year <- year(AMS_rev_and_list$date)

AMS_map <- readOGR("maps/AMS_neighbourhoods.geojson", "OGRGeoJSON")
AMS_price <- summarise(group_by(AMS_rev_and_list,neighbourhood,year),price=median(price))
AMS_rev_year_sum <- summarize(group_by(AMS_rev_and_list, neighbourhood, year, month), number_of_reviews=n())
AMS_map_centers <- gCentroid(AMS_map,byid=T)
AMS_map_label <- cbind(as.data.frame(AMS_map_centers),AMS_map@data$neighbourhood)
remove(AMS_map_centers)
names(AMS_map_label)[3]<-"name"
AMS_map_cart <- fortify(AMS_map)

#LON
names(LON_rev)[names(LON_rev)=="listing_id"] <- "id"
LON_rev_and_list <- inner_join(LON_li,LON_rev,by="id")
remove(LON_li)
remove(LON_rev)

LON_rev_and_list$date <- as.Date(LON_rev_and_list$date)
LON_rev_and_list$month <- month(LON_rev_and_list$date,label=T,abbr=T)
LON_rev_and_list$year <- year(LON_rev_and_list$date)

LON_map <- readOGR("maps/LON_neighbourhoods.geojson", "OGRGeoJSON")
LON_price <- summarise(group_by(LON_rev_and_list,neighbourhood,year),price=median(price))
LON_rev_year_sum <- summarize(group_by(LON_rev_and_list, neighbourhood, year, month), number_of_reviews=n())
LON_map_centers <- gCentroid(LON_map,byid=T)
LON_map_label <- cbind(as.data.frame(LON_map_centers),LON_map@data$neighbourhood)
remove(LON_map_centers)
names(LON_map_label)[3]<-"name"
LON_map_cart <- fortify(LON_map)

#NY
names(NY_rev)[names(NY_rev)=="listing_id"] <- "id"
NY_rev_and_list <- inner_join(NY_li,NY_rev,by="id")
remove(NY_li)
remove(NY_rev)

NY_rev_and_list$date <- as.Date(NY_rev_and_list$date)
NY_rev_and_list$month <- month(NY_rev_and_list$date,label=T,abbr=T)
NY_rev_and_list$year <- year(NY_rev_and_list$date)

NY_map <- readOGR("maps/NY_neighbourhoods.geojson", "OGRGeoJSON")
NY_price <- summarise(group_by(NY_rev_and_list,neighbourhood,year),price=median(price))
NY_rev_year_sum <- summarize(group_by(NY_rev_and_list, neighbourhood, year, month), number_of_reviews=n())
NY_map_centers <- gCentroid(NY_map,byid=T)
NY_map_label <- cbind(as.data.frame(NY_map_centers),NY_map@data$neighbourhood)
remove(NY_map_centers)
names(NY_map_label)[3]<-"name"
NY_map_cart <- fortify(NY_map)

#SF
names(SF_rev)[names(SF_rev)=="listing_id"] <- "id"
SF_rev_and_list <- inner_join(SF_li,SF_rev,by="id")
remove(SF_li)
remove(SF_rev)

SF_rev_and_list$date <- as.Date(SF_rev_and_list$date)
SF_rev_and_list$month <- month(SF_rev_and_list$date,label=T,abbr=T)
SF_rev_and_list$year <- year(SF_rev_and_list$date)

SF_map <- readOGR("maps/SF_neighbourhoods.geojson", "OGRGeoJSON")
SF_price <- summarise(group_by(SF_rev_and_list,neighbourhood,year),price=median(price))
SF_rev_year_sum <- summarize(group_by(SF_rev_and_list, neighbourhood, year, month), number_of_reviews=n())
SF_map_centers <- gCentroid(SF_map,byid=T)
SF_map_label <- cbind(as.data.frame(SF_map_centers),SF_map@data$neighbourhood)
remove(SF_map_centers)
names(SF_map_label)[3]<-"name"
SF_map_cart <- fortify(SF_map)
```

####Question Three's Graph

Third photo's graph needs to do a summary according to the data, neighbourhood, and number of reviews. Number of reviews needs to be counted from a separate file DC_rev. These two files need to be merged according to the list id. This data manipulaion was handled in the processing necessary to answer question 2.

##Design

###Question 1: Listing and host characteristics

![Q1 Graph 1](q1g1.jpg)


To visualize the types of places that are being rented, pie charts or nightingale plots can be used to display frequency of this categorical variable. However, these graphs only allow us to display data from one city at a time. To compare listing types among multiple regions, a stacked bar chart can also be used with region as the independent variable and proportion of listing type as the dependent variable. These graphs will allow us to see if there is a great proportion of listings are entire houses and/or apartments, which BJH Advisors state may potentially contribute to a housing crisis. 

![Q1 Graph 2](q1g2.jpg)


To show the count of listings indidual hosts have, density plots or histograms can be used. Like the pie charts that display listing type, these graphs only allow us to display data from one city at a time. To compare listings per host among multiple regions, we will create separate density plots for each region on the same graph by using `facet_grid()`. These density plots can either be arranged by rows or columns. Hosts with many listings may indicate that they are commercial hosts, which BJH Advisors cite as another effect on the housing crisis. 

![Q1 Graph 3](q1g3.jpg)


The relationship between listing type and listings per host can be shown through the used of barplots that segment hosts into those with few, serveral, and many listings. This will allow us to see if hosts with many listings (i.e., potentially commercial hosts) disproportionately rent out entire properties. 

![Q1 Graph 4](q1g4.jpg)

Our final design that addresses part A is a scatterplot with listing availability (# days out of the year) as the x variable, minimum nights required stay as the y variable. Dots represent individual There The color of the dots is mapped to listing type. The size of each dot is mapped to the calculated host listing count. There are many variables and aesthetic mappings in this graph. It therefore more exploratory in nature, and hopefully will display a relationship among any of these variables. 

###Question 2: Rental prices

![Q2 Graph 1](q2g1.jpg)


To investigate our second research area, we will use geographic and Airbnb/rental price data. This graph will look at listings in a specific region such as Washington DC and display each listing as a `geom_point` object. The color of each point will be mapped to relative price or to neighborhood. Other aesthetic mappings, such as point shape to listing type, can be used for further graph detail. Another iteration of this graph can group listings by neighborhood so listing prices can be examined on an aggregate level. Other variables, such as number of reviews, can also be used. A map of median listing prices can be directly compared with a map of reviews by neighborhood, because it is possible that prices could be higher in neighborhoods that have listings with more reviews.

###Question 3: Frequency of reviews

![Q3 Graph 1](q3g1.jpg)

In order to answer our third research question, we will use a time series plot that shows the count of reviews given for listings in up-and-coming neighborhoods. This will require some data manipulation, including joining the `listings.csv` and `reviews.csv` tables, counting the number of reviews, and grouping by date and neighborhood. Displaying every single neighborhood may make the graph appear too cluttered, so a subset of up-and-coming neighborhoods (i.e., Mission in San Francisco, Williamsburg in Brooklyn) could be selected. Visualizing how the number of reviews for listings in certain neighborhoods have changed over time may indicate their popularity, which could be used to explain urbanization and gentrification. 

##Shiny plot

![Shiny](shiny.jpg)
The design of our shiny plot is an extention of the geographic plots used to explore research question part 2 that allows for greater user interactivity. It is comprised of a click and brush-based interative map. The user will be able to use a drop-down menu to select a specific region, such as Washington DC, San Francisco, or Amsterdam. Listings could either be individual points or aggregations by neighborhood. Initially, all the points would be grey. When a user clicks a point, this will change the color of the point as well as display the listing name and price. When a user brushes a group of points and clicks the toggle button, these points will change color and their listing name, price, and room type will be displayed in a table. Graph settings can be reset to default by clicking the reset button. This will allow us to display listing data from multiple geographic regions on the same plot. 

##Implementation

###Q1G1
```{r Q1G1}
library(tidyverse)
library(ggplot2)
library(gridExtra)


#load dc data
dc_listings <- read.csv("DC_listings.csv")
dc_neighborhoods <- read.csv("DC_neighbourhoods.csv")
dc_reviews <- read.csv("DC_reviews.csv")

#load ny data
ny_listings <- read.csv("NY_listings.csv")
ny_neighborhoods <- read.csv("NY_neighbourhoods.csv")
ny_reviews <- read.csv("NY_reviews.csv")

#load london data
lon_listings <- read.csv("LON_listings.csv")
lon_neighborhoods <- read.csv("LON_neighbourhoods.csv")
lon_reviews <- read.csv("LON_reviews.csv")

#load san francisco data
sf_listings <- read.csv("SF_listings.csv")
sf_neighborhoods <- read.csv("SF_neighbourhoods.csv")
sf_reviews <- read.csv("SF_reviews.csv")

names(dc_listings)
#pie charts for question 1. listings by room type
g_dc <- ggplot(data=dc_listings,aes(x=factor(1),fill=room_type, y=..count../sum(..count..))) + geom_bar(width=1, position="fill", alpha=.7, color="black") + coord_polar(theta="y") +
  labs(title="DC Listings By Room Type", x="", y="")
g_dc <- g_dc + scale_fill_brewer(name="Room Type", palette="Set2")

g_ny <- ggplot(data=ny_listings,aes(x=factor(1),fill=room_type, y=..count../sum(..count..))) + geom_bar(width=1, position="fill", alpha=.7, color="black") + coord_polar(theta="y") +
  labs(title="New York Listings By Room Type", x="", y="")
g_ny <- g_ny + scale_fill_brewer(name="Room Type", palette="Set2")

g_lon <- ggplot(data=lon_listings,aes(x=factor(1),fill=room_type, y=..count../sum(..count..))) + geom_bar(width=1, position="fill", alpha=.7, color="black") + coord_polar(theta="y") +
  labs(title="London Listings By Room Type", x="", y="")
g_lon <- g_lon + scale_fill_brewer(name="Room Type", palette="Set2")

g_sf <- ggplot(data=sf_listings,aes(x=factor(1),fill=room_type, y=..count../sum(..count..))) + geom_bar(width=1, position="fill", alpha=.7, color="black") + coord_polar(theta="y") +
  labs(title="San Francisco Listings By Room Type", x="", y="")
g_sf <- g_sf + scale_fill_brewer(name="Room Type", palette="Set2")

grid.arrange(g_dc,g_ny,g_lon,g_sf)

#nightingale charts for question 1. listings by room type
g2_dc <- ggplot(data=dc_listings) + geom_bar(aes(x=room_type, fill=room_type,color=room_type, y=..count../sum(..count..)),width=1, alpha=.7, color="black") + 
  coord_polar()+scale_y_sqrt() + labs(title="DC Listings By Room Type", x="Room Type", y="Proportion")
g2_dc <- g2_dc + scale_fill_brewer(name="Room_Type", palette="Set2")

g2_ny <- ggplot(data=ny_listings) + geom_bar(aes(x=room_type, fill=room_type,color=room_type, y=..count../sum(..count..)),width=1, alpha=.7, color="black") + 
  coord_polar()+scale_y_sqrt() + labs(title="New York Listings By Room Type", x="Room Type", y="Proportion")
g2_ny <- g2_ny + scale_fill_brewer(name="Room_Type", palette="Set2")

g2_lon <- ggplot(data=lon_listings) + geom_bar(aes(x=room_type, fill=room_type,color=room_type, y=..count../sum(..count..)),width=1, alpha=.7, color="black") + 
  coord_polar()+scale_y_sqrt() + labs(title="London Listings By Room Type", x="Room Type", y="Proportion")
g2_lon <- g2_lon + scale_fill_brewer(name="Room_Type", palette="Set2")

g2_sf <- ggplot(data=sf_listings) + geom_bar(aes(x=room_type, fill=room_type,color=room_type, y=..count../sum(..count..)),width=1, alpha=.7, color="black") + 
  coord_polar()+scale_y_sqrt() + labs(title="San Francisco Listings By Room Type", x="Room Type", y="Proportion")
g2_sf <- g2_sf + scale_fill_brewer(name="Room_Type", palette="Set2")

grid.arrange(g2_dc,g2_ny,g2_lon,g2_sf)

#stacked bar chart
#first add city variable to each dataset before joining
dc_listings$city <- "Washington D.C."
ny_listings$city <- "New York City"
lon_listings$city <- "London"
sf_listings$city <- "San Francisco"

#join all cities
dc_ny <- rbind(dc_listings, ny_listings)
dc_ny_sf <- rbind(dc_ny, sf_listings)
all_listings <- rbind(dc_ny_sf, lon_listings)
all_listings_temp <- all_listings[all_listings$calculated_host_listings_count <= 10,]

#stacked bar chart by room type
g <- ggplot(all_listings) + geom_bar(aes(x=city, fill=room_type, y=..count../sum(..count..)), position="fill", alpha=.7, color="black")
g <- g + labs(title="City Listings By Room Type", x="", y="Relative frequency")
g <- g + scale_fill_brewer(name="Room_Type", palette="Set2")
g
```

Our first graph representations show the percentage of room types in each city. For every city, the percentage of spaces that are shared rooms are very small. For every city except DC, entire apartments and private rooms are about a 50/50 split. In DC, there are significantly more entire apartments being rented than private rooms.

###Q1G2
``` {r Q1G2}
#faceted density plots by city
g <- ggplot(all_listings_temp, aes(x=calculated_host_listings_count, colour=city)) + geom_density() + labs(title="Listings per Host by City", x="Number of Listings Per Host") + facet_grid(city~.)
g

```

For the density plots, they display what is expected that most hosts only offer one to two listings. However, it should be noted that in London and DC, there seems to be a bigger number of hosts that are more like landlords or property managers that offer a large number of spaces.

###Q1G3
```{r Q1G3}
#side by side bar chart looking at room types listed by host type
all_listings$host_type[all_listings$calculated_host_listings_count <= 5] <- "1-5"
all_listings$host_type[all_listings$calculated_host_listings_count > 5 & all_listings$calculated_host_listings_count < 11] <- "6-10"
all_listings$host_type[all_listings$calculated_host_listings_count > 10] <- "10+"

g <- ggplot(all_listings) + geom_bar(aes(x=host_type, y=..count../sum(..count..), fill=room_type), position="dodge", alpha=.7, color="black")
g <- g + labs(title="Types of Rooms Rented by Host Type", x="Listings Per Host", y="Relative Frequency")
g <- g + scale_fill_brewer(name="", palette="Set2" )
g

```

Our side by side chart does not show too much that has not been seen, but there is one interesting observation that as expected, for most host listing counts there is a little bit larger proportion of entire apartments being listed than private rooms. However in the 6-10 range of listings for a host, there seems to be slightly more private rooms than entire apartments.

###Q1G4
```{r Q1G4}

#scatter plot
all_listings <- all_listings[all_listings$minimum_nights < 1000,]
g <- ggplot(all_listings) + geom_point(aes(x=availability_365, y=minimum_nights, size=calculated_host_listings_count, colour=room_type), alpha=.7)
g <- g + labs(title="Availability vs. Minimum Nights for Rental Scatterplot", x="Availability", y="Minimum Nights")
g <- g + scale_fill_brewer(name="", palette="Set2" )
g
```

It's hard to deduct any relationships from this scatter plot. There does not seem to be any relationship with regards to availability during the year. With minimum number of nights though, it seems that the most frequent numbers are 30, 60, and 90 days. Not that surprising. After the 60 day mark, it seems like there are no longer shared rooms so shared rooms seem to be more of a short term listing than the other two offerings.

##Q2

```{r}
#Simple map of neighborhoods in DC
g <- ggplot(DC_map_cart) + geom_polygon(aes(long,lat, group=group),color="grey50",fill="white")
g

#Add neighborhood labels
g <- g + geom_text(data=DC_map_label, aes(x=x,y=y,label=name),size=2)
g

#Add price points. Map color to neighborhood and size to price
DC_list_year <- filter(DC_rev_and_list,year==2012)
g_dc <- g + geom_point(data=DC_list_year,aes(longitude,latitude,color=neighbourhood,size=price,alpha=0.5)) + 
  labs(title="DC Listing Price by Neighborhood") +
  guides(color=FALSE, alpha=FALSE) + 
  coord_map()
g_dc

```

After making a map of DC, we applied the same code to observe listings by neighborhood in other cities.

```{r}
#Create maps for other regions
#Amsterdam
AMS_list_year <- filter(AMS_rev_and_list,year==2012)
ams_g <- ggplot(AMS_map_cart) + 
  geom_polygon(aes(long,lat, group=group),color="grey50",fill="white") +
  geom_text(data=AMS_map_label, aes(x=x,y=y,label=name),size=2) +
  geom_point(data=AMS_list_year,aes(longitude,latitude,color=neighbourhood,size=price,alpha=0.1)) + 
  labs(title="Amsterdam Listing Price by Neighborhood") +
  guides(color=FALSE, alpha=FALSE) + 
  coord_map()

#London
LON_list_year <- filter(LON_rev_and_list,year==2012)
lon_g <- ggplot(LON_map_cart) + 
  geom_polygon(aes(long,lat, group=group),color="grey50",fill="white") +
  geom_text(data=LON_map_label, aes(x=x,y=y,label=name),size=2) +
  geom_point(data=LON_list_year,aes(longitude,latitude,color=neighbourhood,size=price,alpha=0.1)) + 
  labs(title="London Listing Price by Neighborhood") +
  guides(color=FALSE, alpha=FALSE) + 
  coord_map()

#NY
#neighbourhood labels not included because too many neighbourhood
NY_list_year <- filter(NY_rev_and_list,year==2012)
ny_g <- ggplot(NY_map_cart) + 
  geom_polygon(aes(long,lat, group=group),color="grey50",fill="white") +
  geom_point(data=NY_list_year,aes(longitude,latitude,color=neighbourhood,size=price,alpha=0.1)) + 
  labs(title="NY Listing Price by Neighborhood") +
  guides(color=FALSE, alpha=FALSE) + 
  coord_map()

#SF
SF_list_year <- filter(SF_rev_and_list,year==2012)
sf_g <- ggplot(SF_map_cart) + 
  geom_polygon(aes(long,lat, group=group),color="grey50",fill="white") +
  geom_text(data=SF_map_label, aes(x=x,y=y,label=name),size=2) +
  geom_point(data=SF_list_year,aes(longitude,latitude,color=neighbourhood,size=price,alpha=0.1)) + 
  labs(title="SF Listing Price by Neighborhood") +
  guides(color=FALSE, alpha=FALSE) + 
  coord_map()

grid.arrange(ams_g, lon_g, ny_g, sf_g)

```

These graphs accurately display how listing prices vary by neighborhood for the regions we are studying. However, because there is so much information on the graph, the individual map labels are hard to read and individal points are hard to distinguish. Therefore, we implemented these graphs in Shiny to make them dynamic.

![Listings By Region Shiny](ShinyDCShapeMap.png)


The Shiny app is a significant improvement from our static graphs because the plot would be larger. Additionally, we were able to implement features such as zoom, year animation, and city selection.  

![Listings By Region Shiny](ShinySFGoogleMap.png)

Additionally, we used `GGMaps` package to access the Google Maps API and plotted the listing price points on a more visually appealing map. In our Shiny application, user have the option of selecting to view the points on a Google Map. It also allows users to select a neighborhood, which makes a call to the Google Maps API to display a map zoomed into the selected neighborhood.

##Q3

```{r}
library(lubridate)

#Initial plot draft - too many lines, select subset of neighborhoods
g <- ggplot(DC_rev_year_sum, aes(x=month, y=number_of_reviews, color=neighbourhood)) +
    geom_line(aes(group=neighbourhood))+theme_minimal() +
        scale_x_discrete(month(seq(1,12),label=T))+
        labs(y="Number of Reviews")+theme(axis.title.x = element_blank()) +
        guides(color=FALSE)
g
```

The first iteration of our user review time series displays the number of reviews for listings in all neighborhoods in DC from 2009-2015. Because there is so much data stored in this graph, it is not very useful. 

![Reviews Over Time Shiny](ShinyDCTimeSeries.png)

To improve it, we implemented it in Shiny. This allows users to select a year (or an animation of change over time in years). Because we used the `Plotly` package, users are able to select a subset of neighborhoods they would like to analyze. Additionally, users can hover over individual lines, which reveals information about the month, neighborhood, and number reviews at that point.

##Conclusion and Analysis

Our first series of graphs show that for most cities, the percentage of spaces that are shared rooms is very small, and entire apartments and private rooms are about a 50/50 split. However, in DC and San Francisco, there are relatively more entire apartments being rented than private rooms. According to the BJH Advisors report referenced in the introduction, these types of listings may exacerbate the affordable housing crisis. This finding is aligned with current news about the effect of Airbnb on the housing market in San Francisco and Washington DC. In light of the concerns over safety and affordability, D.C. council member Kenyan McDuffie recently proposed a bill would make it illegal for property owners to post multiple addresses for rent and limit the rental period for a property to 15 days in a year. According to Claire Zippel, the large propoprtion of entire homes/apartments being rented is a "significant problem considering that about 1,000 District families are in homeless shelters and overflow motel rooms" [The Washington Post](https://www.washingtonpost.com/local/dc-politics/dc-lawmakers-get-an-earful-on-proposal-to-strictly-regulate-airbnb/2017/04/26/594ef9c2-2a92-11e7-a616-d7c8a68c1a66_story.html?utm_term=.d2579c2c42c9). Our density plot displaying Listings Per Host by City and stacked bar plots visualizing Types of Rooms Rented by Host Type also have results (to varying extents) that may be possible housing crisis indicators. In London and DC, there seems to be a bigger number of hosts that are more like landlords or property managers that offer a large number of spaces. For all listings, hosts with 10+ listing have a slightly higher proportion of entire apartments being listed than private rooms.

However, Airbnb's negative impact may not be as dire as it seems. For example, the Listings By Host density plots have a distribution that is skewed right, indicating that most hosts have 1 or 2 properties, so they probably are not commercial property managers. According to the staked bar charts, the proportional difference between hosts with 10+ listings that rent entire apartments and private rooms is under 10%. This is evidence that Airbnb is probably not the sole contributor to a city's housing crisis, as these are very complex phenomenon with many causal factors. 

Our map visualizations displaying listing price by neighborhood were initially very cluttered because we had so much neighborhood/price data but were limited by a static plot. Therefore, we solved this by creatin a Shiny application. Because this application has many customizable features, it is meant to be exploratory in nature. Take DC for example. Using the Year slider, users are able to see how listing frequency and price has changed over time in Washington DC. In 2010, there are only a few listings, primarily in the Dupont, U St, and Columbia Heights areas. As time elapses, more and more listings are posted in neighborhoods across DC (except Downtown, presumably because most buildings are corporate offices or government buildings). Listing prices seem to generally fall within the less than or equal to $300 range, but some larger points exist in Dupont, Georgetown, Columbia Heights, and U St.

Our two methods of map projection/representation of listings both have their own strengths and weaknesses. We had several problems using the shape files of cities provided by InsideAirBnB. Because we are using ggplot, there is no adequate method to zoom in on the map in a map coordinate system. We could zoom in using cartesian coordinates, but that heavily distorts the map. The other problem was that labels for neighborhoods could not fit adequately cluttering the map. Ultimately, we used the GoogleMaps API or the ggmap package to solve these problems. By using google maps, we can both zoom in on the map to focus in on specific listings better, and we can change neighborhoods by recentering the map to the selected neighborhood rather than dealing with neighborhood lines and labels. The disadvantage of the google maps is you do not get as good of an overall view of the city as with the shape files. One major overall problem we had with both maps is that we couldn't make specific points clickable because we're constantly changing the available points, but we wanted to be able to make each point clickable so that you could see more information about the listing.

Finally, the shiny app's first and third time series graphs "review over time" and "listing price over time" use `ggplotly` to achieve an amazing effect. You can choose specific line to show and hover your mouse over the line to see details at different points in time. The final version of our graph has the aesthetic mappings and labelling necessary to be an informative graph. It indicates that some listings with the have had an increase in reviews over time, while others have not seen much of an increase. For example, by Sept 2015, listings in Union Station (471 reviews), Columbia Heights (441 reviews), and Capitol Hill (402 reviews) had the greatest number of reviews and a general increase over 2015. However, other neighborhoods such as Friendship Heights, Glover Park, and Takoma Park had under 50 reviews in Sept and didnt see much increase over the year. This is aligned with our hypothesis that some neighborhoods are "up-and-coming," which is a signifier of gentrificiation. The graph also shows that there is some seasonailty in review frequency - across most years, there is a spike in reviews in October for some reason. Some weaknesses of our graph are that `ggplotly` can't create custom labels and the default label's messages are untidy. Because the number of neighbourhoods is large, each line's sample size may be small and can give misleading conclusions. The neighbourhood's location is hard to tell and needs to flip back and forth between the map and this graph to study a specific area.